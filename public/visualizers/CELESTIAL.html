<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Celestial Weaver - The Unbroken</title>
    <style>
        :root {
            --bg: #01040D;
            --text: #A0B3D3;
            --highlight: #6EE2FF;
            --panel-bg: rgba(10, 20, 40, 0.75);
            --panel-border: rgba(110, 226, 255, 0.3);
            --hot-color: #ff8033;
        }
        body { margin: 0; background-color: var(--bg); color: var(--text); font-family: 'SF Mono', 'Consolas', 'Menlo', monospace; overflow: hidden; }
        
        #main-canvas { 
            display: block; 
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 1;
            pointer-events: none;
        }
        
        #setup {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text); font-family: monospace; text-align: center;
            border: 1px solid var(--panel-border); padding: 2em;
            background-color: rgba(1, 4, 13, 0.9);
            max-width: 600px;
            box-shadow: 0 0 20px rgba(110, 226, 255, 0.2);
            z-index: 100;
            transition: opacity 0.5s ease-out;
        }
        #setup h2 { 
            margin-top: 0; font-size: 1.8em; color: var(--highlight);
            text-shadow: 0 0 10px var(--highlight);
        }
        #setup .description, #setup .instructions {
            font-size: 0.95em; line-height: 1.6; text-align: left;
            margin: 1.5em auto; color: #ccc;
        }
        #setup h3 {
             margin-top: 2em; border-bottom: 1px solid var(--panel-border);
             padding-bottom: 0.5em; color: var(--text);
        }
        #setup strong { color: var(--highlight); font-weight: bold; }
        #setup ul { padding-left: 20px; text-align: left; }
        #setup li { margin-bottom: 0.5em; }
        #setup select, #setup button {
            display: block; width: 100%; margin-top: 1em; padding: 0.8em;
            background-color: var(--panel-bg); color: var(--highlight);
            border: 1px solid var(--panel-border); font-family: monospace;
            font-size: 1em; cursor: pointer; box-sizing: border-box;
            transition: all 0.2s;
        }
        #setup button:hover { background-color: var(--panel-border); box-shadow: 0 0 10px var(--highlight); }
        #setup button:disabled { background-color: #222; color: #666; cursor: not-allowed; box-shadow: none; }
        
        #toggle-controls-btn {
            position: absolute; top: 20px; left: 20px; z-index: 50;
            width: 40px; height: 40px; background: transparent; border: none;
            cursor: pointer; opacity: 0.5; transition: opacity 0.3s, transform 0.3s;
            padding: 0; display: none;
        }
        #toggle-controls-btn:hover { opacity: 1; transform: rotate(45deg); }
        #toggle-controls-btn svg { width: 100%; height: 100%; fill: var(--highlight); }
        
        #controls-panel {
            position: absolute;
            background: var(--panel-bg); border: 1px solid var(--panel-border);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: 8px; padding: 15px; width: 280px;
            z-index: 40; user-select: none;
            opacity: 0; visibility: hidden; transform: translateY(-20px);
            transition: opacity 0.4s, transform 0.4s, visibility 0.4s;
        }
        #controls-panel.visible {
            opacity: 1; visibility: visible; transform: translateY(0);
        }
        .control-row { margin-bottom: 12px; }
        .control-row label { display: block; margin-bottom: 5px; font-size: 0.8em; opacity: 0.8; }
        .control-row input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 3px; background: var(--panel-border);
            outline: none; transition: opacity .2s; cursor: pointer;
        }
        .control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 12px; height: 12px; background: var(--highlight); border-radius: 50%;
        }
        #panel-header {
            width: 100%; text-align: center; padding-bottom: 10px; margin-bottom: 10px;
            border-bottom: 1px solid var(--panel-border); font-weight: bold;
            color: var(--highlight); cursor: move;
        }
    </style>
</head>
<body>
    <button id="toggle-controls-btn">
        <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
    </button>
    <div id="controls-panel">
        <div id="panel-header">ПАРАМЕТРЫ МИРА</div>
        <div class="control-row"><label for="bloom-slider">Интенсивность Свечения</label><input type="range" id="bloom-slider" min="0" max="2" value="0.5" step="0.01"></div>
        <div class="control-row"><label for="aberration-slider">Хроматические Искажения</label><input type="range" id="aberration-slider" min="0" max="3" value="0.5" step="0.01"></div>
        <div class="control-row"><label for="weaver-chaos-slider">Хаотичность Ткача</label><input type="range" id="weaver-chaos-slider" min="0.1" max="2.0" value="0.8" step="0.05"></div>
        <div class="control-row"><label for="particles-slider">Плотность Гобелена (x1000)</label><input type="range" id="particles-slider" min="5" max="50" value="20" step="1"></div>
    </div>

    <canvas id="main-canvas"></canvas>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.165.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/", "gsap": "https://unpkg.com/gsap@3.12.5/index.js", "gsap/Draggable": "https://unpkg.com/gsap@3.12.5/Draggable.js" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
        import SimplexNoise from 'https://cdn.skypack.dev/simplex-noise@3.0.0';
        import { gsap } from "gsap";
        import { Draggable } from "gsap/Draggable";

        const ChromaticAberrationShader = {
            uniforms: { tDiffuse: { value: null }, uAmount: { value: 0.0 } },
            vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
            fragmentShader: `uniform sampler2D tDiffuse; uniform float uAmount; varying vec2 vUv; void main() { vec2 offset = uAmount * 0.002 * (vUv - 0.5); vec4 cR = texture2D(tDiffuse, vUv + offset); vec4 cG = texture2D(tDiffuse, vUv); vec4 cB = texture2D(tDiffuse, vUv - offset); gl_FragColor = vec4(cR.r, cG.g, cB.b, cG.a); }`
        };

        class CelestialWeaver {
            constructor() {
                this.canvas = document.getElementById('main-canvas');
                this.simplex = new SimplexNoise();
                this.clock = new THREE.Clock();
                this.audioState = { bass: 0, mids: 0, treble: 0, overall: 0 };
                this.weaver = {};
                this.loom = {};
                this.colors = { base: new THREE.Color(), hot: new THREE.Color(0xff8033) };
                this.activeStream = null;
                this.isAnimating = false;
                this.init();
            }

            async init() {
                this.setupScene();
                this.setupPostProcessing();
                this.setupUI();
                window.addEventListener('resize', this.onResize.bind(this));
            }

            setupScene() { /* ... код без изменений ... */ }
            setupPostProcessing() { /* ... код без изменений ... */ }

            async startVis(audioSourcePromise) {
                try {
                    const stream = await audioSourcePromise;
                    await this.initAudio(stream);
                    document.getElementById('toggle-controls-btn').style.display = 'block';

                    if (!this.isAnimating) {
                        this.isAnimating = true;
                        this.createLoom(20000);
                        this.createWeaver();
                        this.animate();
                    }
                } catch(err) {
                    console.error("Не удалось запустить визуализацию:", err);
                    alert(`Ошибка: ${err.message}. Убедитесь, что вы предоставили все необходимые разрешения.`);
                }
            }
            
            setupUI() {
                gsap.registerPlugin(Draggable);
                Draggable.create("#controls-panel", { type:"x,y", bounds: "body", edgeResistance:0.65, trigger:"#panel-header" });
                const controlsPanel = document.getElementById('controls-panel');
                const toggleBtn = document.getElementById('toggle-controls-btn');
                
                toggleBtn.addEventListener('click', () => {
                    const isVisible = controlsPanel.classList.toggle('visible');
                    if (isVisible) {
                        const btnRect = toggleBtn.getBoundingClientRect();
                        controlsPanel.style.top = `${btnRect.bottom + 10}px`;
                        controlsPanel.style.left = `${btnRect.left}px`;
                    }
                });
                
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'START_AUDIO') {
                        if (event.data.source === 'microphone') {
                            const audioPromise = navigator.mediaDevices.getUserMedia({ 
                                audio: { deviceId: event.data.deviceId }, 
                                video: false 
                            });
                            this.startVis(audioPromise);
                        } else if (event.data.source === 'system') {
                            const audioPromise = navigator.mediaDevices.getDisplayMedia({ 
                                video: true, 
                                audio: true 
                            });
                            this.startVis(audioPromise);
                        }
                    }
                });

                document.getElementById('weaver-chaos-slider').addEventListener('input', e => { if (this.weaver.options) this.weaver.options.chaos = parseFloat(e.target.value); });
                document.getElementById('particles-slider').addEventListener('input', e => this.createLoom(parseInt(e.target.value) * 1000));
            }

            async initAudio(stream) { /* ... код без изменений ... */ }
            createLoom(count) { /* ... код без изменений ... */ }
            createWeaver() { /* ... код без изменений ... */ }
            processAudio() { /* ... код без изменений ... */ }
            palette(t, a, b, c, d) { /* ... код без изменений ... */ }
            updateColors() { /* ... код без изменений ... */ }
            updateLoom(time) { /* ... код без изменений ... */ }
            updateWeaver(time) { /* ... код без изменений ... */ }
            onResize() { /* ... код без изменений ... */ }

            animate() {
                if (!this.isAnimating) return;
                requestAnimationFrame(this.animate.bind(this));
                const time = this.clock.getElapsedTime();
                
                if (this.analyser) {
                    this.processAudio();
                } else {
                    this.audioState.bass *= 0.95; this.audioState.mids *= 0.95;
                    this.audioState.treble *= 0.95; this.audioState.overall *= 0.95;
                }
                
                this.updateColors();
                this.updateWeaver(time);
                this.updateLoom(time);
                
                this.camera.position.x += (Math.sin(time * 0.1) * 20 - this.camera.position.x) * 0.01;
                this.camera.lookAt(this.weaver.currentPos);

                const baseBloom = parseFloat(document.getElementById('bloom-slider').value);
                this.bloomPass.strength = baseBloom;
                
                const baseAberration = parseFloat(document.getElementById('aberration-slider').value);
                const finalAberration = baseAberration * (this.audioState.overall * 0.5 + this.audioState.treble * 5);
                this.chromaticPass.uniforms.uAmount.value = finalAberration;

                this.composer.render();
            }
        }
        
        // --- Копирование неизмененных методов ---
        CelestialWeaver.prototype.setupScene = function() { this.scene = new THREE.Scene(); this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 200); this.camera.position.set(0, 0, 30); this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas, antialias: true }); this.renderer.setSize(window.innerWidth, window.innerHeight); this.renderer.setPixelRatio(window.devicePixelRatio); };
        CelestialWeaver.prototype.setupPostProcessing = function() { this.composer = new EffectComposer(this.renderer); this.composer.addPass(new RenderPass(this.scene, this.camera)); this.bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.5, 0.4, 0.85); this.composer.addPass(this.bloomPass); this.chromaticPass = new ShaderPass(ChromaticAberrationShader); this.composer.addPass(this.chromaticPass); };
        CelestialWeaver.prototype.initAudio = async function(stream) { if (this.activeStream) { this.activeStream.getTracks().forEach(track => track.stop()); } this.activeStream = stream; if (stream.getAudioTracks().length === 0) { throw new Error("Аудио-дорожка не найдена в предоставленном потоке."); } const audioCtx = new (window.AudioContext || window.webkitAudioContext)(); this.analyser = audioCtx.createAnalyser(); this.analyser.fftSize = 512; this.analyser.smoothingTimeConstant = 0.8; const source = audioCtx.createMediaStreamSource(stream); source.connect(this.analyser); this.frequencyData = new Uint8Array(this.analyser.frequencyBinCount); };
        CelestialWeaver.prototype.createLoom = function(count) { if (this.loom.mesh) { this.loom.mesh.geometry.dispose(); this.loom.mesh.material.dispose(); this.scene.remove(this.loom.mesh); } const geometry = new THREE.IcosahedronGeometry(0.05, 0); const material = new THREE.MeshBasicMaterial({ color: 0xffffff }); this.loom.mesh = new THREE.InstancedMesh(geometry, material, count); this.loom.initialPositions = []; this.loom.initialScales = []; const dummy = new THREE.Object3D(); for (let i = 0; i < count; i++) { const phi = Math.acos(-1 + (2 * i) / count); const theta = Math.sqrt(count * Math.PI) * phi; const radius = 15 + Math.random() * 20; dummy.position.set(radius * Math.cos(theta) * Math.sin(phi), radius * Math.sin(theta) * Math.sin(phi), radius * Math.cos(phi)); const scale = 0.5 + Math.random() * 0.5; dummy.scale.set(scale, scale, scale); this.loom.initialScales.push(scale); dummy.updateMatrix(); this.loom.mesh.setMatrixAt(i, dummy.matrix); this.loom.initialPositions.push(dummy.position.clone()); } this.scene.add(this.loom.mesh); };
        CelestialWeaver.prototype.createWeaver = function() { const points = Array.from({ length: 200 }, () => new THREE.Vector3(0,0,0)); const curve = new THREE.CatmullRomCurve3(points); const geometry = new THREE.TubeGeometry(curve, 199, 0.2, 8, false); const material = new THREE.MeshBasicMaterial({ color: 0xffffff }); this.weaver.mesh = new THREE.Mesh(geometry, material); this.weaver.curve = curve; this.weaver.currentPos = new THREE.Vector3(); this.weaver.options = { chaos: 0.8 }; this.scene.add(this.weaver.mesh); };
        CelestialWeaver.prototype.processAudio = function() { if (!this.analyser) return; this.analyser.getByteFrequencyData(this.frequencyData); const data = this.frequencyData; const bass = (data[1] + data[2] + data[3]) / 3 / 255; const mids = (data.slice(40, 80).reduce((a,b)=>a+b, 0) / 40) / 255; const treble = (data.slice(100, 150).reduce((a,b)=>a+b, 0) / 50) / 255; const overall = data.reduce((a, b) => a + b, 0) / data.length / 255; this.audioState.bass += (bass - this.audioState.bass) * 0.1; this.audioState.mids += (mids - this.audioState.mids) * 0.1; this.audioState.treble += (treble - this.audioState.treble) * 0.1; this.audioState.overall += (overall - this.audioState.overall) * 0.1; };
        CelestialWeaver.prototype.palette = function(t, a, b, c, d) { return new THREE.Color().setRGB(a.x + b.x * Math.cos(6.28318 * (c.x * t + d.x)), a.y + b.y * Math.cos(6.28318 * (c.y * t + d.y)), a.z + b.z * Math.cos(6.28318 * (c.z * t + d.z))); };
        CelestialWeaver.prototype.updateColors = function() { const colorTime = this.audioState.mids; const dynamicBase = this.palette(colorTime, new THREE.Vector3(0.5, 0.5, 0.5), new THREE.Vector3(0.5, 0.5, 0.5), new THREE.Vector3(1.0, 1.0, 1.0), new THREE.Vector3(0.0, 0.1, 0.2)); this.colors.base.lerpColors(dynamicBase, this.colors.hot, this.audioState.bass * 2); const emissiveIntensity = 1.0 + this.audioState.overall * 5.0 + this.audioState.bass * 3.0; const finalColor = this.colors.base.clone().multiplyScalar(emissiveIntensity); if(this.weaver.mesh) this.weaver.mesh.material.color.copy(finalColor); if(this.loom.mesh) this.loom.mesh.material.color.copy(finalColor).multiplyScalar(0.5); };
        CelestialWeaver.prototype.updateLoom = function(time) { if (!this.loom.mesh) return; const dummy = new THREE.Object3D(); const noiseFactor = 1 + this.audioState.mids * 5; const overallDisplacement = this.audioState.overall * 2; for (let i = 0; i < this.loom.mesh.count; i++) { this.loom.mesh.getMatrixAt(i, dummy.matrix); const initial = this.loom.initialPositions[i]; const initialScale = this.loom.initialScales[i]; const noise = this.simplex.noise3D(initial.x * 0.1, initial.y * 0.1 + time * 0.1, initial.z * 0.1); dummy.position.copy(initial).addScaledVector(initial.clone().normalize(), noise * noiseFactor + overallDisplacement); const finalScale = initialScale * (1 + this.audioState.overall * 2); dummy.scale.set(finalScale, finalScale, finalScale); dummy.updateMatrix(); this.loom.mesh.setMatrixAt(i, dummy.matrix); } this.loom.mesh.instanceMatrix.needsUpdate = true; };
        CelestialWeaver.prototype.updateWeaver = function(time) { if (!this.weaver.mesh) return; const chaos = this.weaver.options.chaos; this.weaver.currentPos.x = Math.sin(time * (0.11 * chaos)) * 10 + Math.cos(time * (0.23 * chaos)) * 5; this.weaver.currentPos.y = Math.cos(time * (0.09 * chaos)) * 10 + Math.sin(time * (0.28 * chaos)) * 5; this.weaver.currentPos.z = Math.sin(time * (0.15 * chaos)) * 10; this.weaver.curve.points.shift(); this.weaver.curve.points.push(this.weaver.currentPos.clone()); const crackle = this.simplex.noise2D(time * 50, 0) * this.audioState.treble * 0.4; const newRadius = (0.1 + this.audioState.bass * 1.5) + crackle; this.weaver.mesh.geometry.dispose(); this.weaver.mesh.geometry = new THREE.TubeGeometry(this.weaver.curve, 199, newRadius, 8, false); };
        CelestialWeaver.prototype.onResize = function() { this.camera.aspect = window.innerWidth / window.innerHeight; this.camera.updateProjectionMatrix(); this.renderer.setSize(window.innerWidth, window.innerHeight); this.composer.setSize(window.innerWidth, window.innerHeight); };
        
        new CelestialWeaver();
    </script>
</body>
</html>
